<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.szmsd.putinstorage.mapper.InboundReceiptDetailMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="ReceiptDetailVO" type="com.szmsd.putinstorage.domain.vo.InboundReceiptDetailVO">
        <id column="id" property="id"/>
        <result column="warehouse_no" property="warehouseNo"/>
        <result column="sku" property="sku"/>
        <result column="sku_name" property="skuName"/>
        <result column="declare_qty" property="declareQty"/>
        <result column="put_qty" property="putQty"/>
        <result column="origin_code" property="originCode"/>
        <result column="delivery_no" property="deliveryNo"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Column_List_VO">
        t.id,
        t.warehouse_no,
        t.sku,
        t.sku_name,
        t.declare_qty,
        t.put_qty,
        t.origin_code,
        t.delivery_no,
        t.remark
    </sql>
    <delete id="deleteByWarehouseNo">
        DELETE
        FROM inbound_receipt_detail
        WHERE warehouse_no = #{warehouseNo}
    </delete>
    <select id="selectList" parameterType="com.szmsd.putinstorage.domain.dto.InboundReceiptDetailQueryDTO"
            resultMap="ReceiptDetailVO">
        SELECT
        <include refid="Column_List_VO"/>
        FROM inbound_receipt_detail t
        <where>
            <if test="id != null and id != ''">
                AND t.id = #{id}
            </if>
            <if test="warehouseNo != null and warehouseNo != ''">
                AND t.warehouse_no = #{warehouseNo}
            </if>
            <if test="sku != null and sku != ''">
                AND t.sku = #{sku}
            </if>
        </where>
    </select>

    <select id="querySkuStockByRange" resultType="com.szmsd.putinstorage.domain.vo.SkuInventoryStockRangeVo">
        SELECT sku,
               sku_name,
               SUM(declare_qty) AS forecastTotal,
               SUM(put_qty)        actualOnShelvesTotal,
               SUM(inTransitTotal) inTransitTotal
        FROM (
                     SELECT sku,
                            sku_name,
                            declare_qty,
                            put_qty,
                            IF
                                    ((declare_qty - put_qty) > 0, (declare_qty - put_qty), 0) AS inTransitTotal
                     FROM `inbound_receipt_detail`
                    <where>
                        <if test="timeStart != null and timeEnd != null">
                            AND create_time >= #{timeStart,jdbcType=TIMESTAMP} AND create_time &lt;= #{timeEnd,jdbcType=TIMESTAMP}
                        </if>
                    </where>
                     ) temp
        GROUP BY sku
    </select>
</mapper>
